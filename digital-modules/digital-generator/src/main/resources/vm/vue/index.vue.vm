<script setup lang="ts">
    import type { VbenFormProps } from '@vben/common-ui';
    import type { Recordable } from '@vben/types';
    import type { VxeGridProps } from '#/adapter/vxe-table';

    import { Page, useVbenModal } from '@vben/common-ui';
    import { getPopupContainer } from '@vben/utils';
    import { Modal, Popconfirm, Space } from 'ant-design-vue';

    import { useVbenVxeGrid, vxeCheckboxChecked } from '#/adapter/vxe-table';
    import {
        del${BusinessName},
        export${BusinessName},
        list${BusinessName},
    } from '@/api/${moduleName}/${businessName}';
    import { commonDownloadExcel } from '#/utils/file/download';

    import { columns, querySchema } from './data';
    import ${BusinessName}Modal from './${businessName}-modal.vue';

    const formOptions: VbenFormProps = {
        commonConfig: {
            labelWidth: 80,
        },
        schema: querySchema(),
        wrapperClass: 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4',
    };

    const gridOptions: VxeGridProps = {
        checkboxConfig: {
            highlight: true,
            reserve: true,
        },
        columns,
        height: 'auto',
        keepSource: true,
        pagerConfig: {},
        proxyConfig: {
            ajax: {
                query: async ({ page }, formValues = {}) => {
                    return await list${BusinessName}({
                        pageNum: page.currentPage,
                        pageSize: page.pageSize,
                        ...formValues,
                    });
                },
            },
        },
        rowConfig: {
            isHover: true,
            keyField: 'id',
        },
    };

    const [BasicTable, tableApi] = useVbenVxeGrid({
        formOptions,
        gridOptions,
    });

    const [FormModal, modalApi] = useVbenModal({
        connectedComponent: ${BusinessName}Modal,
    });

    function handleAdd() {
        modalApi.setData({});
        modalApi.open();
    }

    async function handleEdit(record: Recordable<any>) {
        modalApi.setData({ id: record.id });
        modalApi.open();
    }

    async function handleDelete(row: Recordable<any>) {
        await del${BusinessName}(row.id);
        await tableApi.query();
    }

    function handleMultiDelete() {
        const rows = tableApi.grid.getCheckboxRecords();
        const ids = rows.map((row: any) => row.id);
        Modal.confirm({
            title: '提示',
            okType: 'danger',
            content: `确认删除选中的\${ids.length}条记录吗？`,
            onOk: async () => {
                await del${BusinessName}(ids);
                await tableApi.query();
            },
        });
    }
</script>

<template>
    <Page :auto-content-height="true">
        <BasicTable>
            <template #toolbar-actions>
                <span class="pl-[7px] text-[16px]">${functionName}列表</span>
            </template>
            <template #toolbar-tools>
                <Space>
                    <a-button
                        v-access:code="['${moduleName}:${businessName}:export']"
                        @click="
                            commonDownloadExcel(
                            export${BusinessName},
                            '${functionName}数据',
                            tableApi.formApi.form.values,
                            )
                            "
                    >
                        {{ $t('pages.common.export') }}
                    </a-button>
                    <a-button
                        :disabled="!vxeCheckboxChecked(tableApi)"
                        danger
                        type="primary"
                        v-access:code="['${moduleName}:${businessName}:remove']"
                        @click="handleMultiDelete"
                    >
                        {{ $t('pages.common.delete') }}
                    </a-button>
                    <a-button
                        type="primary"
                        v-access:code="['${moduleName}:${businessName}:add']"
                        @click="handleAdd"
                    >
                        {{ $t('pages.common.add') }}
                    </a-button>
                </Space>
            </template>
            <template #action="{ row }">
                <Space>
                    <ghost-button
                        v-access:code="['${moduleName}:${businessName}:edit']"
                        @click.stop="handleEdit(row)"
                    >
                        {{ $t('pages.common.edit') }}
                    </ghost-button>
                    <Popconfirm
                        :get-popup-container="getPopupContainer"
                        placement="left"
                        title="确认删除？"
                        @confirm="handleDelete(row)"
                    >
                        <ghost-button
                            danger
                            v-access:code="['${moduleName}:${businessName}:remove']"
                            @click.stop=""
                        >
                            {{ $t('pages.common.delete') }}
                        </ghost-button>
                    </Popconfirm>
                </Space>
            </template>
        </BasicTable>
        <FormModal @reload="tableApi.query()" />
    </Page>
</template>
